<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Edit Diary Event</title>
<style>
* { margin:0; padding:0; box-sizing:border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
body {
    background: linear-gradient(135deg,#2c2c2c,#1a1a1a);
    min-height:100vh;
    display:flex;
    justify-content:center;
    align-items:flex-start;
    padding:20px;
}
.container {
    width:100%;
    max-width:700px;
    background:#f5f4f0;
    border-radius:15px;
    padding:30px;
    box-shadow:0 15px 40px rgba(0,0,0,0.3);
}
h1 { text-align:center; color:#333; margin-bottom:20px; }
form input, form textarea {
    width:100%;
    padding:12px;
    margin-bottom:10px;
    border-radius:8px;
    border:1px solid #ddd;
}
form button {
    padding:12px 20px;
    background:#4a90e2;
    color:white;
    border:none;
    border-radius:8px;
    cursor:pointer;
}
form button:hover { background:#357ABD; }
.media-preview { display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
.media-item { position: relative; display:flex; flex-direction:column; align-items:center; }
.media-item img, .media-item video, .media-item audio {
    max-width:100px; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.1);
}
.remove-btn {
    position:absolute;
    top:-5px; right:-5px;
    background:red; color:white; border:none; border-radius:50%;
    width:20px; height:20px; cursor:pointer; font-weight:bold;
}
</style>
</head>
<body>
<div class="container">
    <h1>Edit Event</h1>
    <form id="edit-event-form" enctype="multipart/form-data">
        <input type="text" id="event-title" placeholder="Event Title" required>
        <textarea id="event-desc" placeholder="Description (optional)"></textarea>
        <input type="file" id="event-media" name="media" multiple accept="image/*,video/*,audio/*">
        <div class="media-preview" id="media-preview"></div>
        <button type="submit">Save Changes</button>
    </form>
</div>

<script>
const API_BASE_URL = "http://localhost:3000/api";
const token = localStorage.getItem('token');

const urlParams = new URLSearchParams(window.location.search);
const date = urlParams.get('date');
const eventId = urlParams.get('eventId');

const form = document.getElementById('edit-event-form');
const titleInput = document.getElementById('event-title');
const descInput = document.getElementById('event-desc');
const mediaInput = document.getElementById('event-media');
const mediaPreview = document.getElementById('media-preview');

let existingMedia = []; // Track current media
let removedMedia = [];  // Track removed media filenames

async function loadEvent(){
    try {
        const res = await fetch(`${API_BASE_URL}/diary/${date}`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await res.json();
        if(!res.ok) throw new Error(data.message || 'Failed to load event');

        const event = data.data.events.find(ev => ev._id === eventId);
        if(!event) return alert('Event not found');

        titleInput.value = event.title;
        descInput.value = event.description || '';
        existingMedia = event.media || [];

        renderMedia();
    } catch(err){
        console.error(err);
        alert('Error loading event');
    }
}

function renderMedia(){
    mediaPreview.innerHTML = '';
    existingMedia.forEach((file, index) => {
        const type = file.split('.').pop().toLowerCase();
        const div = document.createElement('div');
        div.className = 'media-item';

        let mediaEl;
        if(['jpg','jpeg','png','gif'].includes(type)){
            mediaEl = document.createElement('img');
            mediaEl.src = `${API_BASE_URL}/${file}`;
        } else if(['mp4','webm','ogg'].includes(type)){
            mediaEl = document.createElement('video');
            mediaEl.src = `${API_BASE_URL}/${file}`;
            mediaEl.controls = true;
        } else if(['mp3','wav','ogg'].includes(type)){
            mediaEl = document.createElement('audio');
            mediaEl.src = `${API_BASE_URL}/${file}`;
            mediaEl.controls = true;
        }

        const removeBtn = document.createElement('button');
        removeBtn.textContent = 'Ã—';
        removeBtn.className = 'remove-btn';
        removeBtn.onclick = () => {
            removedMedia.push(file);
            existingMedia.splice(index, 1);
            renderMedia();
        }

        div.appendChild(mediaEl);
        div.appendChild(removeBtn);
        mediaPreview.appendChild(div);
    });
}

// Submit updated event
form.onsubmit = async (e) => {
    e.preventDefault();
    const formData = new FormData();
    formData.append('title', titleInput.value);
    formData.append('description', descInput.value);
    formData.append('removedMedia', JSON.stringify(removedMedia));

    for(const file of mediaInput.files){
        formData.append('media', file);
    }

    try {
        const res = await fetch(`${API_BASE_URL}/diary/${date}/${eventId}`, {
            method: 'PUT',
            headers: { 'Authorization': `Bearer ${token}` },
            body: formData
        });
        const data = await res.json();
        if(!res.ok) throw new Error(data.message || 'Failed to update event');

        alert('Event updated successfully!');
        window.location.href = `diary-dashboard.html`;
    } catch(err){
        console.error(err);
        alert('Error updating event');
    }
}

// Load event initially
loadEvent();
</script>
</body>
</html>
