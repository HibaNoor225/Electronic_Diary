<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Diary - Add Events</title>
<style>
* { margin:0; padding:0; box-sizing:border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
body {
    background: linear-gradient(135deg,#2c2c2c,#1a1a1a);
    min-height:100vh;
    display:flex;
    justify-content:center;
    align-items:flex-start;
    padding:20px;
}
.container {
    width:100%;
    max-width:700px;
    background:#f5f4f0;
    border-radius:15px;
    padding:30px;
    box-shadow:0 15px 40px rgba(0,0,0,0.3);
}
h1 { text-align:center; color:#333; margin-bottom:20px; }

.event-card { 
    background:white; 
    border-radius:10px; 
    padding:15px; 
    margin-bottom:15px; 
    box-shadow:0 5px 15px rgba(0,0,0,0.1);
}
.event-card input, .event-card textarea {
    width:100%; 
    padding:10px; 
    margin-bottom:10px; 
    border-radius:8px; 
    border:1px solid #ddd;
}
.event-card .remove-event-btn {
    padding:5px 10px; 
    border:none; 
    border-radius:5px; 
    background:#e74c3c; 
    color:white; 
    cursor:pointer;
}
.media-preview { display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
.media-preview img, .media-preview video, .media-preview audio{
    max-width:100px; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.1);
}

button#add-event-btn, button#save-all-btn {
    padding:12px 20px; 
    background:#4a90e2; 
    color:white; 
    border:none; 
    border-radius:8px; 
    cursor:pointer; 
    font-weight:500; 
    width:100%; 
    margin-bottom:15px;
}
button#add-event-btn:hover, button#save-all-btn:hover { background:#357ABD; }

.no-events { color:#666; text-align:center; margin-top:10px; }
</style>
</head>
<body>
<div class="container">
    <h1 id="page-title">Diary Events</h1>

    <div id="events-list"></div>

    <button id="add-event-btn">+ Add Another Event</button>
    <button id="save-all-btn">Save All Events</button>
</div>

<script>
const API_BASE_URL = "http://localhost:5000/api";
const token = localStorage.getItem('token');

// Get date from URL query
const urlParams = new URLSearchParams(window.location.search);
const date = urlParams.get('date') || new Date().toISOString().split('T')[0];
document.getElementById('page-title').textContent = `Diary Events - Date ${date}`;

const eventsList = document.getElementById('events-list');
const addEventBtn = document.getElementById('add-event-btn');
const saveAllBtn = document.getElementById('save-all-btn');

// Function to create a new event form
function createEventForm(eventData = {}) {
    const div = document.createElement('div');
    div.className = 'event-card';
    div.innerHTML = `
        <input type="text" placeholder="Event Title" class="event-title" value="${eventData.title || ''}" required>
        <textarea placeholder="Description (optional)" class="event-desc">${eventData.description || ''}</textarea>
        <input type="file" class="event-media" multiple accept="image/*,video/*,audio/*">
        <button class="remove-event-btn" type="button">Remove</button>
        <div class="media-preview"></div>
        <hr>
    `;
    div.querySelector('.remove-event-btn').onclick = () => div.remove();
    eventsList.appendChild(div);

    // Show media previews if existing media is provided
    if(eventData.media && eventData.media.length > 0){
        const mediaDiv = div.querySelector('.media-preview');
        eventData.media.forEach(file => {
            const type = file.type.split('/')[0];
            if(type==='image'){ const img=document.createElement('img'); img.src=`${API_BASE_URL}/${file.url}`; mediaDiv.appendChild(img);}
            else if(type==='video'){ const vid=document.createElement('video'); vid.src=`${API_BASE_URL}/${file.url}`; vid.controls=true; mediaDiv.appendChild(vid);}
            else if(type==='audio'){ const aud=document.createElement('audio'); aud.src=`${API_BASE_URL}/${file.url}`; aud.controls=true; mediaDiv.appendChild(aud);}
        });
    }
}

// Load existing events from backend and create forms
async function loadEvents(){
    eventsList.innerHTML = '';
    try {
        const res = await fetch(`${API_BASE_URL}/diary/${date}`, {
            headers:{ 'Authorization': `Bearer ${token}` }
        });
        const data = await res.json();
        if(!res.ok) throw new Error(data.message);

        const events = data.data || [];
        if(events.length === 0){
            createEventForm(); // empty form
        } else {
            events.forEach(ev => createEventForm(ev));
        }
    } catch(err){
        console.error(err);
        createEventForm(); // empty form if error
    }
}

// Add another event form
addEventBtn.onclick = () => createEventForm();

// Save all events
saveAllBtn.onclick = async () => {
    const forms = document.querySelectorAll('.event-card');
    if(forms.length === 0) return alert("Add at least one event");

    for(const form of forms){
        const title = form.querySelector('.event-title').value;
        const desc = form.querySelector('.event-desc').value;
        const mediaFiles = form.querySelector('.event-media').files;

        const formData = new FormData();
        formData.append('title', title);
        formData.append('description', desc);
        formData.append('date', date);
        for(const file of mediaFiles) formData.append('media', file);

        try {
            const res = await fetch(`${API_BASE_URL}/diary`, {
                method:'POST',
                headers:{ 'Authorization': `Bearer ${token}` },
                body: formData
            });
            const data = await res.json();
            if(!res.ok) throw new Error(data.message);
        } catch(err){
            console.error(err);
            alert('Failed to save one or more events');
            return;
        }
    }
    alert("All events saved!");
    loadEvents(); // reload with empty/new forms
};

// Initial load
loadEvents();
</script>
</body>
</html>
